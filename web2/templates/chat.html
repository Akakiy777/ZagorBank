<!-- chat.html -->
{% extends "base.html" %}

{% block css %}
<style>
    .chat-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        height: calc(100vh - 180px);
        max-height: 800px;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        padding: 16px 20px;
        border-bottom: 1px solid #eaeaea;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #fafafa;
    }

    .chat-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
    }

    .chat-main {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .chat-sidebar {
        width: 280px;
        border-right: 1px solid #eaeaea;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-search {
        padding: 16px;
        border-bottom: 1px solid #eaeaea;
    }

    .chat-search-input {
        width: 100%;
        padding: 10px 16px 10px 40px;
        border-radius: 20px;
        border: 1px solid #ddd;
        font-size: 0.9rem;
        background: #f5f5f5 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E") no-repeat 15px center;
        transition: all 0.3s ease;
    }

    .chat-search-input:focus {
        outline: none;
        border-color: #7341ff;
        background-color: white;
        box-shadow: 0 0 0 2px rgba(115, 65, 255, 0.2);
    }

    .chat-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0;
    }

    .chat-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        transition: background-color 0.2s ease;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
    }

    .chat-item:hover {
        background-color: #f5f5f5;
    }

    .chat-item.active {
        background-color: #f0ebff;
    }

    .chat-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .chat-item-info {
        flex: 1;
        min-width: 0;
    }

    .chat-item-name {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-item-balance {
        font-size: 0.8rem;
        color: #777;
    }

    .chat-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-current-user {
        padding: 16px 20px;
        border-bottom: 1px solid #eaeaea;
        display: flex;
        align-items: center;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .message {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-break: break-word;
    }

    .message-incoming {
        align-self: flex-start;
        background-color: #f0f0f0;
        border-bottom-left-radius: 4px;
    }

    .message-outgoing {
        align-self: flex-end;
        background-color: #7341ff;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-time {
        font-size: 0.7rem;
        margin-top: 6px;
        opacity: 0.8;
    }

    .message-outgoing .message-time {
        color: rgba(255, 255, 255, 0.8);
    }

    .chat-input-container {
        padding: 16px 20px;
        border-top: 1px solid #eaeaea;
        background: #fafafa;
    }

    .chat-input-form {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        padding: 12px 16px;
        border-radius: 24px;
        border: 1px solid #ddd;
        font-size: 0.95rem;
        resize: none;
        min-height: 24px;
        max-height: 120px;
        transition: border-color 0.3s ease;
    }

    .chat-input:focus {
        outline: none;
        border-color: #7341ff;
    }

    .chat-send-btn {
        background-color: #7341ff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex-shrink: 0;
    }

    .chat-send-btn:hover {
        background-color: #633bdf;
    }

    .file-input-label {
        background-color: #f0f0f0;
        color: #333;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex-shrink: 0;
    }

    .file-input-label:hover {
        background-color: #e0e0e0;
    }

    .back-to-main {
        display: block;
        text-align: center;
        padding: 12px;
        background-color: #7341ff;
        color: white;
        text-decoration: none;
        font-weight: 500;
        transition: background-color 0.3s ease;
    }

    .back-to-main:hover {
        background-color: #633bdf;
    }

    .file-message {
        margin-top: 8px;
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .file-message a {
        color: inherit;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .file-message a:hover {
        text-decoration: underline;
    }

    /* Адаптивность для мобильных устройств */
    @media (max-width: 900px) {
        .chat-main {
            flex-direction: column;
        }

        .chat-sidebar {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid #eaeaea;
            height: 40%;
            max-height: 300px;
        }

        .chat-content {
            height: 60%;
        }
    }

    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 160px);
            border-radius: 0;
            box-shadow: none;
        }

        .chat-header {
            padding: 12px 16px;
        }

        .chat-title {
            font-size: 1.1rem;
        }

        .chat-search {
            padding: 12px;
        }

        .chat-item {
            padding: 10px 12px;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
        }

        .chat-current-user {
            padding: 12px 16px;
        }

        .chat-messages {
            padding: 16px;
        }

        .message {
            max-width: 85%;
            padding: 10px 14px;
        }

        .chat-input-container {
            padding: 12px 16px;
        }

        .chat-input-form {
            gap: 8px;
        }

        .chat-send-btn,
        .file-input-label {
            width: 44px;
            height: 44px;
        }
    }

    @media (max-width: 480px) {
        .chat-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .chat-item-name {
            font-size: 0.9rem;
        }

        .chat-item-balance {
            font-size: 0.75rem;
        }

        .message {
            max-width: 90%;
        }

        .chat-input {
            font-size: 0.9rem;
            padding: 10px 14px;
        }
    }

    /* Стили для превью файлов */
    .file-previews {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px;
        background-color: #f9f9f9;
        border-bottom: 1px solid #eaeaea;
        max-height: 150px;
        overflow-y: auto;
    }

    .file-preview {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100px;
        padding: 8px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .file-preview-icon {
        font-size: 2rem;
        margin-bottom: 5px;
        color: #7341ff;
    }

    .file-preview-name {
        font-size: 0.7rem;
        text-align: center;
        word-break: break-all;
        max-height: 2.8em;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .file-preview-remove {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #ff3333;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.8rem;
        border: none;
    }

    .hidden {
        display: none;
    }
</style>
{% endblock %}
{% block navbar %}
{% endblock %}
{% block content %}
<div class="chat-container">
    <div class="chat-main">
        <aside class="chat-sidebar">
            <div class="chat-search">
                <input type="text" class="chat-search-input" placeholder="Поиск чатов..." id="chatSearchInput">
            </div>
            <div class="chat-list">
                <a href="/chat/{{ this[1] }}/{{ this[1] }}" class="chat-item">
                    <img src="{{ url_for('static', filename='avatars/'+this[5] ) }}"
                        class="chat-avatar {% if this[1] in admin %}admin-img{% endif %}" alt="Ваш профиль">
                    <div class="chat-item-info">
                        <div class="chat-item-name">Вы</div>
                        <div class="chat-item-balance">Z {{ this[3] }}</div>
                    </div>
                </a>

                {% for user in users %}
                {% if user[1] != this[1] %}
                <a href="/chat/{{ this[1] }}/{{ user[1] }}"
                    class="chat-item {% if user[1] == currentUser[1] %}active{% endif %}">
                    <img src="{{ url_for('static', filename='avatars/'+user[5] ) }}"
                        class="chat-avatar {% if user[1] in admin %}admin-img{% endif %}" alt="{{ user[1] }}">
                    <div class="chat-item-info">
                        <div class="chat-item-name">{{ user[1] }}</div>
                        <div class="chat-item-balance">Ƶ <span class="formattedBalance">{{ user[3] }}</span></div>
                    </div>
                </a>
                {% endif %}
                {% endfor %}
            </div>
        </aside>

        <div class="chat-content">
            <div class="chat-current-user">
                <img src="{{ url_for('static', filename='avatars/'+currentUser[5] ) }}"
                    class="chat-avatar {% if currentUser[1] in admin %}admin-img{% endif %}" alt="{{ currentUser[1] }}">
                <div class="chat-item-info">
                    <div class="chat-item-name">{{ currentUser[1] }}</div>
                    <div class="chat-item-balance">Z {{ currentUser[3] }}</div>
                </div>
            </div>

            <div class="chat-messages" id="message-container">
                {% for msg in messages %}
                {% if msg[1] == this[1] and msg[2] == currentUser[1] %}
                <div class="message message-outgoing">
                    <p>{{ msg[3] }}</p>
                    <form action="/delete" method="post">
                        <button type="submit" class="file-preview-remove">&times;</button>
                        <input type="text" hidden name="table" value="messages">
                        <input type="text" hidden name="id" value="{{ msg[0] }}">
                    </form>
                    {% if msg[5] %}
                    {% set files = msg[5].split() %}
                    {% for file in files %}
                    <div class="file-message">
                        <a href="{{ url_for('static', filename='files/'+file) }}" download
                            style="text-decoration: none;overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                            <span class="material-symbols-outlined">description</span>
                            Скачать {{ file }}
                        </a>
                    </div>
                    {% endfor %}
                    {% endif %}
                    <div class="message-time">{{ msg[4] }}</div>
                </div>
                {% elif msg[1] == currentUser[1] and msg[2] == this[1] %}
                <div class="message message-incoming">
                    <p>{{ msg[3] }}</p>
                    {% if this[1] in admin %}<form action="/delete" method="post">
                        <button type="submit" class="file-preview-remove">&times;</button>
                        <input type="text" hidden name="table" value="messages">
                        <input type="text" hidden name="id" value="{{ msg[0] }}">
                    </form>{% endif %}
                    {% if msg[5] %}
                    {% set files = msg[5].split() %}
                    {% for file in files %}
                    <div class="file-message" style="background: white;">
                        <a href="{{ url_for('static', filename='files/'+file) }}" download
                            style="text-decoration: none;overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                            <span class="material-symbols-outlined">description</span>
                            Скачать {{ file }}
                        </a>
                    </div>
                    {% endfor %}
                    {% endif %}
                    <div class="message-time">{{ msg[4] }}</div>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <div class="chat-input-container">
                <!-- Контейнер для превью файлов -->
                <div class="file-previews hidden" id="file-previews"></div>

                <form action="/send_message/{{ this[1] }}/{{ currentUser[1] }}" method="post" class="chat-input-form"
                    enctype="multipart/form-data" id="chat-form">
                    <textarea name="message" class="chat-input" placeholder="Введите сообщение..."
                        id="message-input"></textarea>
                    <input type="file" name="files" id="fileInputMultiple" multiple style="display: none;">
                    <label for="fileInputMultiple" class="file-input-label">
                        <span class="material-symbols-outlined">attach_file</span>
                    </label>
                    <button type="submit" class="chat-send-btn">
                        <span class="material-symbols-outlined">send</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Функция для прокрутки вниз
    function scrollToBottom() {
        const container = document.getElementById('message-container');
        container.scrollTop = container.scrollHeight;
    }

    // Прокрутка вниз при загрузке страницы
    document.addEventListener("DOMContentLoaded", function () {
        scrollToBottom();
    });

    // Поиск чатов
    const chatSearchInput = document.getElementById('chatSearchInput');
    const chatItems = document.querySelectorAll('.chat-item');

    chatSearchInput.addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();

        chatItems.forEach(item => {
            const chatName = item.querySelector('.chat-item-name').textContent.toLowerCase();
            if (chatName.includes(searchTerm) || searchTerm === '') {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });

    // Автоматическое увеличение высоты текстового поля
    const chatInput = document.querySelector('.chat-input');
    if (chatInput) {
        chatInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }

    // Показ имени выбранного файла
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.addEventListener('change', function () {
            if (this.files.length > 0) {
                // Можно добавить отображение имени файла, если нужно
                console.log('Выбран файл:', this.files[0].name);
            }
        });
    }
    // Функция для сокращения имени файла с сохранением расширения
    function shortenFileName(fileName, maxLength = 50) {
        if (fileName.length <= maxLength) return fileName;

        const lastDotIndex = fileName.lastIndexOf('.');
        if (lastDotIndex === -1) {
            // Если нет расширения, просто обрезаем
            return fileName.substring(0, maxLength - 3) + '...';
        }

        const extension = fileName.substring(lastDotIndex);
        const nameWithoutExt = fileName.substring(0, lastDotIndex);

        // Оставляем место для расширения и многоточия
        const maxNameLength = maxLength - extension.length - 3;

        if (maxNameLength <= 0) {
            // Если имя слишком короткое даже для расширения
            return '...' + extension;
        }

        return nameWithoutExt.substring(0, maxNameLength) + '...' + extension;
    }

    // Обработка выбора нескольких файлов
    const fileInput1 = document.getElementById('fileInputMultiple');
    const filePreviews = document.getElementById('file-previews');
    const form = document.getElementById('chat-form');
    let selectedFiles = [];

    fileInput1.addEventListener('change', function () {
        if (this.files.length > 0) {
            filePreviews.classList.remove('hidden');

            // Добавляем новые файлы к существующим
            for (let i = 0; i < this.files.length; i++) {
                selectedFiles.push(this.files[i]);
                addFilePreview(this.files[i]);
            }

            // Сбрасываем input, чтобы можно было выбрать те же файлы снова
            this.value = '';
        }
    });

    // Функция добавления превью файла
    function addFilePreview(file) {
        const preview = document.createElement('div');
        preview.className = 'file-preview';
        preview.dataset.name = file.name;

        // Определяем иконку в зависимости от типа файла
        let icon = 'description';
        if (file.type.startsWith('image/')) {
            icon = 'image';
        } else if (file.type.startsWith('video/')) {
            icon = 'videocam';
        } else if (file.type.includes('pdf')) {
            icon = 'picture_as_pdf';
        } else if (file.type.includes('zip') || file.type.includes('rar') || file.type.includes('tar')) {
            icon = 'folder_zip';
        }

        const shortName = shortenFileName(file.name);

        preview.innerHTML = `
            <span class="material-symbols-outlined file-preview-icon">${icon}</span>
            <div class="file-preview-name" title="${file.name}">${shortName}</div>
            <button type="button" class="file-preview-remove">&times;</button>
        `;

        // Обработчик удаления файла
        const removeBtn = preview.querySelector('.file-preview-remove');
        removeBtn.addEventListener('click', function () {
            // Удаляем файл из массива
            const index = selectedFiles.findIndex(f => f.name === file.name);
            if (index !== -1) {
                selectedFiles.splice(index, 1);
            }

            // Удаляем превью
            preview.remove();

            // Скрываем контейнер, если файлов не осталось
            if (selectedFiles.length === 0) {
                filePreviews.classList.add('hidden');
            }
        });

        filePreviews.appendChild(preview);
    }

    // Обработка отправки формы
    form.addEventListener('submit', function (e) {
        // Если есть выбранные файлы, добавляем их в FormData
        if (selectedFiles.length > 0) {
            e.preventDefault();

            const formData = new FormData(form);

            // Удаляем старые файлы из FormData (если есть)
            formData.delete('files');

            // Добавляем все выбранные файлы
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });

            // Отправляем форму
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        // Перезагружаем страницу после успешной отправки
                        window.location.reload();
                    } else {
                        console.error('Ошибка отправки сообщения');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
        }
        // Если файлов нет, форма отправится обычным способом
    });

    // Автоматическое увеличение высоты текстового поля
    const chatInput1 = document.querySelector('.chat-input');
    if (chatInput1) {
        chatInput1.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }
</script>
{% endblock %}